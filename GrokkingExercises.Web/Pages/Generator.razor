@page "/generator"
@using GrokkingExercises.Core.Domain.ExerciseGenerator
@inject ExerciseGeneratorService GeneratorService

<PageTitle>Gerador de Exerc√≠cios</PageTitle>

<h1>‚öôÔ∏è Gerador de Exerc√≠cios</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4>Criar Novo Exerc√≠cio</h4>
            </div>
            <div class="card-body">
                <EditForm Model="@currentTemplate" OnValidSubmit="@GenerateExercise">
                    <div class="mb-3">
                        <label class="form-label">N√∫mero do Cap√≠tulo</label>
                        <InputText class="form-control" @bind-Value="currentTemplate.ChapterNumber" placeholder="Ex: 02" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">T√≠tulo do Cap√≠tulo</label>
                        <InputText class="form-control" @bind-Value="currentTemplate.ChapterTitle" placeholder="Ex: Selection Sort" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">N√∫mero do Exerc√≠cio</label>
                        <InputText class="form-control" @bind-Value="currentTemplate.ExerciseNumber" placeholder="Ex: 2.1" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">T√≠tulo do Exerc√≠cio</label>
                        <InputText class="form-control" @bind-Value="currentTemplate.ExerciseTitle" placeholder="Ex: Implementa√ß√£o B√°sica" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <InputTextArea class="form-control" rows="3" @bind-Value="currentTemplate.Description"
                                      placeholder="Descreva o que o exerc√≠cio deve fazer..." />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exemplo de Uso</label>
                        <InputText class="form-control" @bind-Value="currentTemplate.Example"
                                  placeholder="Ex: SelectionSort([3,1,4]) -> [1,3,4]" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tipo de Retorno</label>
                        <InputSelect class="form-select" @bind-Value="currentTemplate.ReturnType">
                            <option value="int">int</option>
                            <option value="int[]">int[]</option>
                            <option value="string">string</option>
                            <option value="string[]">string[]</option>
                            <option value="bool">bool</option>
                            <option value="void">void</option>
                            <option value="List<int>">List&lt;int&gt;</option>
                            <option value="(int, int)">(int, int)</option>
                        </InputSelect>
                    </div>

                    <h5 class="mt-4">Par√¢metros</h5>
                    @foreach (var param in currentTemplate.Parameters)
                    {
                        <div class="parameter-row mb-2">
                            <div class="row">
                                <div class="col-md-3">
                                    <InputSelect class="form-select" @bind-Value="param.Type">
                                        <option value="int">int</option>
                                        <option value="int[]">int[]</option>
                                        <option value="string">string</option>
                                        <option value="bool">bool</option>
                                    </InputSelect>
                                </div>
                                <div class="col-md-4">
                                    <InputText class="form-control" @bind-Value="param.Name" placeholder="Nome" />
                                </div>
                                <div class="col-md-4">
                                    <InputText class="form-control" @bind-Value="param.Description" placeholder="Descri√ß√£o" />
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveParameter(param)">√ó</button>
                                </div>
                            </div>
                        </div>
                    }

                    <button type="button" class="btn btn-secondary btn-sm mt-2" @onclick="AddParameter">
                        + Adicionar Par√¢metro
                    </button>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            ‚ö° Gerar C√≥digo
                        </button>
                    </div>
                </EditForm>

                @if (errors.Any())
                {
                    <div class="alert alert-danger mt-3">
                        <h6>‚ùå Erros de Valida√ß√£o:</h6>
                        <ul>
                            @foreach (var error in errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h4>üìÑ Preview do C√≥digo</h4>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(generatedCode))
                {
                    <ul class="nav nav-tabs" role="tablist">
                        @foreach (var file in generatedFiles)
                        {
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(selectedFile == file.Key ? "active" : "")"
                                        @onclick="() => SelectFile(file.Key)">
                                    @file.Key
                                </button>
                            </li>
                        }
                    </ul>

                    <div class="code-preview mt-3">
                        <pre><code>@generatedCode</code></pre>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-success" @onclick="DownloadCurrentFile">
                            üì• Download @selectedFile
                        </button>
                        <button class="btn btn-info" @onclick="CopyToClipboard">
                            üìã Copiar C√≥digo
                        </button>
                    </div>

                    <div class="alert alert-info mt-3">
                        <h6>üìã Pr√≥ximos Passos:</h6>
                        <ol>
                            <li>Fa√ßa download dos arquivos gerados</li>
                            <li>Copie para as pastas apropriadas</li>
                            <li>Adicione ao Program.cs</li>
                            <li>Implemente os m√©todos</li>
                        </ol>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-5">
                        <p>Preencha o formul√°rio e clique em "Gerar C√≥digo" para ver o preview.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .code-preview {
        max-height: 500px;
        overflow-y: auto;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
    }

    .code-preview pre {
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
    }

    .parameter-row {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
</style>

@code {
    private ExerciseTemplate currentTemplate = new()
    {
        Parameters = new List<Parameter> { new Parameter() }
    };

    private List<string> errors = new();
    private Dictionary<string, string> generatedFiles = new();
    private string generatedCode = string.Empty;
    private string selectedFile = string.Empty;

    private void AddParameter()
    {
        currentTemplate.Parameters.Add(new Parameter());
    }

    private void RemoveParameter(Parameter param)
    {
        if (currentTemplate.Parameters.Count > 1)
        {
            currentTemplate.Parameters.Remove(param);
        }
    }

    private void GenerateExercise()
    {
        // Valida template
        errors = GeneratorService.ValidateTemplate(currentTemplate);

        if (errors.Any())
        {
            return;
        }

        // Gera arquivos
        generatedFiles = GeneratorService.GenerateChapter(
            currentTemplate.ChapterNumber,
            currentTemplate.ChapterTitle,
            new List<ExerciseTemplate> { currentTemplate });

        // Seleciona primeiro arquivo
        selectedFile = generatedFiles.Keys.First();
        generatedCode = generatedFiles[selectedFile];
    }

    private void SelectFile(string fileName)
    {
        selectedFile = fileName;
        generatedCode = generatedFiles[fileName];
    }

    private async Task DownloadCurrentFile()
    {
        // TODO: Implementar download do arquivo
        // Blazor Server precisa usar JSInterop para download
    }

    private async Task CopyToClipboard()
    {
        // TODO: Implementar c√≥pia para clipboard
        // Blazor Server precisa usar JSInterop
    }
}
